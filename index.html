<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yusuf Bıyık</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="fluiditype.css">
</head>
<body onload="loadContent('detailed-gallery', 'projelerim')">
    <div class="container">
        <div class="topbar">
            <a target="_blank" href="https://github.com/yussufbiyik">GitHub</a>
            <a target="_blank" href="https://codepen.io/yusufbiyik">CodePen</a>
            <a href="mailto:yussuf.jpeg@gmail.com">yussuf.jpeg@gmail.com</a>
        </div>
        <div class="content border-no-hover">
            <div id="bio" class="left-content">
                <div id="bio-text">
                    <h1>Yusuf Bıyık</h1>
                    <p id="bio-paragraph">Yazılıma 8. sınıfta HTML, CSS ve PHP öğrenerek başladım ve o günden beri kendim, çevrem ve müşterilerim için kendimi aşan projeler yaparak gelişiyorum.</p>    
                </div>
                <div class="link-list">
                    <a id="projelerim" onclick="loadContent('detailed-gallery', 'projelerim')" href="#content">Projelerim</a>
                    <a id="snippets" onclick="loadContent('custom', 'snippets')" href="#content">Ufak Parçalar</a>
                    <a id="yetkinliklerim" onclick="loadContent('custom', 'yetkinliklerim')" href="#content">Yetkinliklerim</a>
                    <a id="pixel-art" onclick="loadContent('gallery', 'pixel-art')" href="#content">Pixel Art</a>
                    <a id="3d-modelleme-renderlar" onclick="loadContent('gallery', '3d-modelleme-renderlar')" href="#content">3D Modelleme/Renderlar</a>
                    <div class="language-selector">
                        <div class="language-select" title="Türkçe" id="turkish" data-name="tr"></div>
                        <div class="language-select" title="English" id="english" data-name="eng"></div>
                    </div>
                    <div class="pattern-selector">
                        <div class="pattern-select" title="noise" id="noiseBackgroundPattern" data-name="noise"></div>
                        <div class="pattern-select" title="dna" id="dnaBackgroundPattern" data-name="dna"></div>
                    </div>
                    <div class="theme-selector">
                        <div class="theme-select" title="darkside" id="darkside" data-name="darkside"></div>
                        <div class="theme-select" title="flashbang" id="flashbang" data-name="flashbang"></div>
                        <div class="theme-select" title="neo" id="neo" data-name="neo"></div>
                        <div class="theme-select" title="bios" id="bios" data-name="bios"></div>
                        <div class="theme-select" title="sepia" id="sepia" data-name="sepia"></div>
                    </div>
                    <small style="gap: 2px;display: grid;grid-auto-flow: column;align-items: center;justify-content: start;">
                        <input type="checkbox" name="bgAnimationCheckbox" id="bgAnimationCheckbox">
                        <label for="bgAnimationCheckbox">Arka plan değişimini kapat.</label>
                    </small>
                    <small>En iyi deneyim için masaüstünde ziyaret edin.</small>
                    <small>
                        Kasmalar yaşayabilirsiniz, <abbr style="cursor: help;" title="SVG filter ile yapıldığı için bi tık zorluyor, çözmeye, olmazsa da alternatiflerini bulmaya çalışıyorum merak etmeyin.">arka plandan</abbr> kaynaklanıyor.
                    </small>
                </div>
            </div>
            <div id="content" class="right-content moveable">
                <h2 id="content-heading"></h2>
                <div id="content-details" class="">
                </div>
            </div>
        </div>
        <div class="bottombar">
            <!-- 
                TODO:
                    * Add Turkish profanity filter then add English,
                    * Add commands for some easter eggs and backsite gateways.
            -->
            <span><img height="14px" src="./assets/icons/chaticon.png" alt=""> Chat</span>
            <div id="chat-box">
                <div id="chat-messages"></div>
                <div id="chat-input-container">
                    <input placeholder="Mesajını gir, lütfen kötü konuşma." type="text" id="message-input">
                    <button id="message-submit-button">→</button>
                </div>
            </div>
        </div>
    </div>
    <svg id="svg-filter" width='300' height='300' style="display: none;">
        <filter id='noiseFilter'>
            <feTurbulence 
                id="turbulence"
                type='turbulence' 
                baseFrequency='.99' 
                numOctaves='2' 
                stitchTiles='stitch'
                result="turbulence">
            </feTurbulence>
            <feDisplacementMap
                id="dispMap"
                in2="turbulence"
                in="SourceGraphic"
                result="fractal"
                scale="-1920"
                xChannelSelector="R"
                yChannelSelector="G">
            </feDisplacementMap>
        </filter>
    </svg>
    <script src="./datasource.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script> -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getFirestore, doc, collection, query, orderBy, onSnapshot, addDoc, Timestamp, where } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js"

        // var userIpAdress;
        // axios.get('https://api.ipify.org', {"Content-Type": "application/json"})
        //     .then(function (response) {
        //         userIpAdress = response.data
        //         console.log(response.data);
        //     })
        //     .catch(function (error) {
        //         console.log(error);
        //     })

        // I learnt that this was okay to expose
        // https://stackoverflow.com/a/37484053/9969425
        const firebaseConfig = {
            apiKey: "AIzaSyCqIOggNSBuMQlH-MVzbKTq7ebc6ZWVWL8",
            authDomain: "yusufbiyik-4a3c4.firebaseapp.com",
            projectId: "yusufbiyik-4a3c4",
            storageBucket: "yusufbiyik-4a3c4.appspot.com",
            messagingSenderId: "162196856906",
            appId: "1:162196856906:web:597a6a772c65190ad186b3"
        };

        // Initialize Firebase
        const fireApp = initializeApp(firebaseConfig);
        const cloudDatabase = getFirestore(fireApp);
        const msNow = Date.now();
        /*
            To list messages from only the last 6 hours:
            get this out of the comment line 
            const nowTimestamp = Timestamp.fromDate(new Date(msNow-21600000))
            add this to the query 
            ,where("createdAt", ">=", nowTimestamp)
        */
        // List chat messages in ascending order of creation date
        const q = query(collection(cloudDatabase, "chat-messages"), orderBy("createdAt", "asc"));
        // Define a variable to determine if the all the messages loaded initally
        var didMessagesLoad = false;
        var userIdentifier = Math.floor(100000 + Math.random() * 900000);
        console.log(localStorage.getItem("username"))
        var username = (localStorage.getItem("username") === null) ? "Anonim" + userIdentifier : localStorage.getItem("username");
        const chatMessagesElement = document.getElementById('chat-messages');


        const messages = [];
        var htmlRegex = /<(?:"[^"]*"['"]*|'[^']*'['"]*|[^'">])+>/g;
        // Following 2 functions return values that are CSS classes, these classes modify the look of the message.
        const isKnownUser = (name) => {
            switch (name) {
                case "yusufbiyik":
                    return "isAdmin"
                case "server":
                    return "isServer"
            }
        }
        const isPinned = (pinValue) => {if(pinValue && pinValue == true) return "isPinned"}
        const serverMessageCreator = (message) => {
            return {
                author:"server",
                message: message,
                isPinned: true,
                createdAt: Timestamp.fromDate(new Date())
            }
        }
        // Turns message createdAt(creation date) to HH:MM:SS format
        const formatCreationDate = (docData) => {
            const messageTime = new Date(docData.createdAt.seconds*1000).toTimeString().split(' ')[0];
            return messageTime
        }
        function generateMessageHTML(docData, messageId) {
            if(messageId == undefined) messageId = "";
            return `<div class="chat-message ${isPinned(docData.isPinned)}" id="${messageId}">
                        <span class="message-hour">[${formatCreationDate(docData)}]:</span>
                        <span class="message-author">[<span class="${isKnownUser(docData.author)}">${docData.author}</span>]: </span>
                        <span class="message">${docData.message}</span>
                    </div>`
        }
        // Triggers when collection is changed whether by a new document or by an updated one
        const unsubscribe = onSnapshot(q, (querySnapshot) => {
            // If messages were initally loaded, then there is no need to load all the messages again,
            // so otherwise load only the changes,
            // Following if statement does exactly that.
            if(didMessagesLoad === false) {
                querySnapshot.forEach((doc) => {
                    messages.push(doc.data());
                    // Add the message to the message container
                    chatMessagesElement.innerHTML += generateMessageHTML(doc.data(), doc.id);
                });
                didMessagesLoad = true;
                // Send info messages
                chatMessagesElement.innerHTML += generateMessageHTML(serverMessageCreator("/nick kullaniciadi şeklinde kullanıcı adını tanımlayabilirsin."));
                chatMessagesElement.innerHTML += generateMessageHTML(serverMessageCreator("You can set your username by using /nick username command"));
                // Scroll to bottom
                chatMessagesElement.scrollTop = chatMessagesElement.offsetHeight;
            }else {
                querySnapshot.docChanges().forEach(change => {
                    messages.push(change.doc.data())
                    // Add the message to the message container
                    chatMessagesElement.innerHTML += generateMessageHTML(change.doc.data(), change.doc.id);
                })
                // Scroll to bottom if the user isn't far away from it
                if(chatMessagesElement.scrollHeight<200) {chatMessagesElement.scrollTop = chatMessagesElement.offsetHeight}
            }
        });

        const commands = [
            {
                name:"nick",
                execute: (parameters) => {
                    username = parameters.join("-") + userIdentifier;
                    localStorage.setItem("username", username)
                    chatMessagesElement.innerHTML += generateMessageHTML(serverMessageCreator("Komut başarılı, kullanıcı adın artık " + username + " // Command executed, your new username is " + username));
                }
            }
        ]

        function commandManager(message) {
            // Delete the first character of the string ("/")
            const parsedMessage = message.slice(1).split(" ");
            // Get the first item (command name)
            const commandName = parsedMessage[0];
            // Delete the first item so the array only contains parameters
            parsedMessage.shift();
            const commandParameters = parsedMessage;
            // If there is such command then execute it
            if(commands.find(command => command.name === commandName) != undefined) {
                const command = commands.find(command => command.name === commandName);
                command.execute(commandParameters)
                return;
            }else {
                chatMessagesElement.innerHTML += generateMessageHTML(serverMessageCreator("Komut bulunamadı // Command not found"));
            }
            userMessageInput.value = "";
        }

        const userMessageInput = document.getElementById("message-input");
        const messageSubmitButton = document.getElementById("message-submit-button");
        // Auto click the submit button if the key is enter
        userMessageInput.addEventListener("keypress", (event) => {
            if(!(event.keyCode == 13)) return;
            messageSubmitButton.click();
        });
        // Add the message to the collection
        messageSubmitButton.onclick = async () => {
            // Return if the message is empty
            if(userMessageInput.value.trim().length < 1) return;
            // Clean the empty spaces, delete HTML tags and define the message
            const messageInputValue = userMessageInput.value.trim().replace(htmlRegex, "");
            // Check if the message is a command
            if(messageInputValue.startsWith('/')) {commandManager(messageInputValue); return;}
            // Clear the message input
            userMessageInput.value = "";
            // Add the message to the document
            await addDoc(collection(cloudDatabase, "chat-messages"), {
                author:username,
                message:messageInputValue,
                isPinned: false,
                createdAt: Timestamp.fromDate(new Date())
            })
        }
    </script>
    <script src="./app.js"></script>
<!--     
               ▀                    ▀
     ▄█   ▄█▄  ▄█    ▄▄▄▄███▄▄▄▄    ▄█  
     ███ ▄███▀ ███  ▄██▀▀▀███▀▀▀██▄ ███  
     ███▐██▀   ███▌ ███   ███   ███ ███▌ 
    ▄█████▀    ███▌ ███   ███   ███ ███▌ 
    ▀█████▄    ███▌ ███   ███   ███ ███▌ 
      ███▐██▄   ███  ███   ███   ███ ███  
      ███ ▀███▄ ███  ███   ███   ███ ███  
      ███   ▀█▀ █▀    ▀█   ███   █▀  █▀   
      ▀                                     
-->
</body>
</html>